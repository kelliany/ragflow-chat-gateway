<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½åŠ©æ‰‹</title>
    <style>
        /* ç®€å•çš„åŠ è½½åŠ¨ç”»ï¼Œæå‡ä½“éªŒ */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #666; font-size: 14px;
        }
    </style>
</head>
<body>

  <div id="loading">æ­£åœ¨è¿æ¥å®‰å…¨é€šé“...</div>

  <iframe id="float-btn"
    style="position:fixed;bottom:20px;right:20px;width:100px;height:100px;border:none;background:transparent;z-index:9999;display:none"
    frameborder="0" allow="microphone;camera">
  </iframe>

<script>
// ==========================================
// ğŸ”‘ æ ¸å¿ƒå ä½ç¬¦
// Node.js åç«¯åœ¨è¯»å–è¿™ä¸ªæ–‡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨æŠŠä¸‹é¢è¿™ä¸²å­—ç¬¦æ›¿æ¢æˆçœŸæ­£çš„ Token
// ==========================================
const CURRENT_TOKEN = "__INJECTED_TOKEN__"; 

// è‡ªåŠ¨è¯†åˆ«å½“å‰ç½‘å…³çš„åœ°å€ (ä¾‹å¦‚ http://10.215.208.98:3000)
const GATEWAY_ORIGIN = window.location.origin;

async function initChat() {
    // ç®€å•æ£€æŸ¥ä¸€ä¸‹ Token æ˜¯å¦è¢«æ›¿æ¢æˆåŠŸäº†
    if (CURRENT_TOKEN === '__' + 'INJECTED_TOKEN' + '__') {
        console.error('é”™è¯¯ï¼šToken æœªæ³¨å…¥ï¼Œè¯·å‹¿ç›´æ¥æ‰“å¼€ HTML æ–‡ä»¶ï¼Œå¿…é¡»é€šè¿‡ http://ip:3000/view è®¿é—®');
        document.getElementById('loading').innerText = 'é…ç½®é”™è¯¯ï¼šè¯·é€šè¿‡ç½‘å…³è®¿é—®';
        return;
    }

    console.log('âœ… å®‰å…¨é€šé“å·²å»ºç«‹');
    document.getElementById('loading').style.display = 'none'; // éšè—åŠ è½½æç¤º

    // 1. åŠ è½½æ‚¬æµ®çƒ
    const btnIframe = document.getElementById('float-btn');
    btnIframe.src = `${GATEWAY_ORIGIN}/next-chats/widget?key=agent-chat-button&token=${CURRENT_TOKEN}`;
    btnIframe.style.display = 'block'; // æ˜¾ç¤ºæŒ‰é’®
}

// å¯åŠ¨åˆå§‹åŒ–
initChat();

// ==========================================
// 2. ç›‘å¬æ¶ˆæ¯ (å¼¹å‡ºå¤§çª—å£)
// ==========================================
window.addEventListener('message', e => {
  if (e.origin !== GATEWAY_ORIGIN) return;
  
  if (e.data.type === 'CREATE_CHAT_WINDOW') {
    if (document.getElementById('chat-win')) return;
    
    // ä½¿ç”¨æ³¨å…¥çš„ Token åˆ›å»ºå¤§çª—å£é“¾æ¥
    const safeSrc = `${GATEWAY_ORIGIN}/next-chats/widget?key=agent-01&w=500px&h=600px&token=${CURRENT_TOKEN}`;
    
    // åŠ¨æ€æå–å®½åº¦é«˜åº¦ (å¯é€‰)
    const urlObj = new URL(safeSrc);
    const width = urlObj.searchParams.get('w') || '500px';
    const height = urlObj.searchParams.get('h') || '600px';

    const i = document.createElement('iframe');
    i.id = 'chat-win';
    i.src = safeSrc;
    // æ ·å¼é…ç½®ï¼šå³ä¸‹è§’å¼¹å‡ºï¼Œå¸¦é˜´å½±
    i.style.cssText = `position:fixed;bottom:104px;right:24px;width:${width};height:${height};border:none;background:transparent;z-index:9998;display:none; box-shadow: 0 5px 20px rgba(0,0,0,0.2); border-radius: 8px; background-color: white;`;
    
    i.frameBorder = '0';
    i.allow = 'microphone;camera';
    document.body.appendChild(i);
    
  } else if (e.data.type === 'TOGGLE_CHAT') {
    const w = document.getElementById('chat-win');
    if (w) w.style.display = e.data.isOpen ? 'block' : 'none';
  }
});
</script>
</body>
</html>