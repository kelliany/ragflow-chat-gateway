<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç½‘å…³é‰´æƒé›†æˆæµ‹è¯• - æ¨¡æ‹Ÿ OA ç³»ç»Ÿ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
        .config-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        .success { background: #e7f4e9; color: #2e7d32; display: block; }
        .error { background: #fbe9e7; color: #d84315; display: block; }
        input { padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        /* é¡µé¢å±…ä¸­åŠ è½½æç¤º */
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #666; font-size: 14px;
        }
    </style>
</head>
<body>

<div class="config-panel">
    <h2>ğŸ›¡ï¸ ç½‘å…³é‰´æƒæµ‹è¯•å·¥å…·</h2>
    <p>
        <strong>1. å¡«å†™å£ä»¤ (CLIENT_SECRET):</strong><br>
        <input type="password" id="clientSecret" value="bestvwin2026">
    </p>
    <p>
        <strong>2. é€‰æ‹© Agent Key:</strong><br>
        <input type="text" id="agentKey" value="agent-01">
    </p>
    <button onclick="startTest()">â‘  æ¢å– Token å¹¶åˆå§‹åŒ–èŠå¤©æŒ‰é’®</button>
</div>

<div id="statusBox" class="status"></div>

<div id="loading">ç­‰å¾…èº«ä»½éªŒè¯...</div>

<iframe id="float-btn"
    style="position:fixed;bottom:20px;right:20px;width:100px;height:100px;border:none;background:transparent;z-index:9999;display:none"
    frameborder="0" allow="microphone;camera">
</iframe>

<script>
    let CURRENT_TOKEN = '';
    const GATEWAY_ORIGIN = window.location.origin;

    /**
     * æ­¥éª¤ 1: ç‚¹å‡»æŒ‰é’®æ¢å– Token
     */
    async function startTest() {
        const secret = document.getElementById('clientSecret').value;
        const statusBox = document.getElementById('statusBox');
        
        statusBox.className = 'status';
        statusBox.innerText = 'æ­£åœ¨å‘ç½‘å…³è¯·æ±‚ Token...';

        try {
            const response = await fetch(`/api/get-token?secret=${secret}`);
            const data = await response.json();

            if (data.success) {
                statusBox.className = 'status success';
                statusBox.innerText = `âœ… Token è·å–æˆåŠŸï¼`;
                
                // æˆåŠŸè·å– Token åå†å¼€å¯åç»­é€»è¾‘
                CURRENT_TOKEN = data.token;
                initChat(); 
            } else {
                throw new Error(data.error || 'è·å– Token å¤±è´¥');
            }
        } catch (err) {
            statusBox.className = 'status error';
            statusBox.innerText = `âŒ é”™è¯¯: ${err.message}`;
        }
    }

    /**
     * æ­¥éª¤ 2: åˆå§‹åŒ–æ‚¬æµ®çƒ
     */
    function initChat() {
        if (!CURRENT_TOKEN) return;

        console.log('âœ… å®‰å…¨é€šé“å·²å»ºç«‹');
        document.getElementById('loading').style.display = 'none';

        // å°† Token æ³¨å…¥æ‚¬æµ®çƒ URL
        const btnIframe = document.getElementById('float-btn');
        btnIframe.src = `${GATEWAY_ORIGIN}/next-chats/widget?key=agent-chat-button&token=${CURRENT_TOKEN}`;
        btnIframe.style.display = 'block'; 
    }

    /**
     * æ ¸å¿ƒç›‘å¬å™¨ï¼šå¤„ç†æ¥è‡ªç½‘å…³çš„æ‰€æœ‰æ¶ˆæ¯
     */
    window.addEventListener('message', e => {
        // 1. æ¥æºéªŒè¯
        if (e.origin !== GATEWAY_ORIGIN) return;
        
        // 2. çŠ¶æ€é”ï¼šå¦‚æœæ²¡æœ‰ Tokenï¼ˆæŒ‰é’®æ²¡ç‚¹ï¼‰ï¼Œç›´æ¥å¿½ç•¥æ‰€æœ‰æ¶ˆæ¯
        // é˜²æ­¢ Iframe é¢„åŠ è½½è„šæœ¬è‡ªåŠ¨è§¦å‘é€»è¾‘
        if (!CURRENT_TOKEN) {
            console.warn('[OAç³»ç»Ÿ] æ‹¦æˆªåˆ°æœªæˆæƒè§¦å‘è¯·æ±‚');
            return;
        }

        const chatWinId = 'chat-win';
        const chatWin = document.getElementById(chatWinId);

        // --- A. UI å‚æ•°è‡ªåŠ¨åŒæ­¥ ---
        if (e.data.type === 'UI_CONFIG') {
            if (chatWin) {
                chatWin.style.width = e.data.width || '500px';
                chatWin.style.height = e.data.height || '600px';
                console.log(`âœ… å·²åº”ç”¨ç½‘å…³ä¸‹å‘çš„ UI é…ç½®: ${e.data.width}x${e.data.height}`);
            }
        }
        
        // --- B. åˆ›å»ºå¯¹è¯çª—å£ ---
        if (e.data.type === 'CREATE_CHAT_WINDOW') {
            if (chatWin) return;
            
            // å®šä¹‰å‰ç«¯é¢„è®¾å°ºå¯¸ï¼ˆä¼šç”± proxy.js è®°å½•å¹¶ä¼ ç»™ RAGFlowï¼‰
            const dynamicW = '400px'; 
            const dynamicH = '900px';
            const agentKey = document.getElementById('agentKey').value;

            // æ„å»ºå¸¦æœ‰ width/height å’Œ token çš„å®‰å…¨åœ°å€
            const safeSrc = `${GATEWAY_ORIGIN}/next-chats/widget?key=agent-01&width=${dynamicW}&height=${dynamicH}&token=${CURRENT_TOKEN}`;
            
            const i = document.createElement('iframe');
            i.id = chatWinId;
            i.src = safeSrc;
            
            // åˆå§‹æ ·å¼è®¾ç½®
            i.style.cssText = `
                position:fixed; bottom:104px; right:24px;
                width:${dynamicW}; height:${dynamicH};
                border:none; background:white; z-index:9998; 
                display:none; box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
                border-radius: 8px; transition: all 0.3s ease;
            `;
            
            i.frameBorder = '0';
            i.allow = 'microphone;camera';
            document.body.appendChild(i);

        } else if (e.data.type === 'TOGGLE_CHAT') {
            if (chatWin) chatWin.style.display = e.data.isOpen ? 'block' : 'none';
        }
    });
</script>

</body>
</html>