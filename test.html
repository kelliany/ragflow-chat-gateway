<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç½‘å…³é‰´æƒé›†æˆæµ‹è¯• - æ¨¡æ‹Ÿ OA ç³»ç»Ÿ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
        .config-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        .success { background: #e7f4e9; color: #2e7d32; display: block; }
        .error { background: #fbe9e7; color: #d84315; display: block; }
        input { padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        /* èŠå¤©æŒ‰é’®æ ·å¼ */
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #666; font-size: 14px;
        }
    </style>
</head>
<body>

<div class="config-panel">
    <h2>ğŸ›¡ï¸ ç½‘å…³é‰´æƒæµ‹è¯•å·¥å…·</h2>
    <p>
        <strong>1. å¡«å†™å£ä»¤ (CLIENT_SECRET):</strong><br>
        <input type="password" id="clientSecret" value="bestvwin2026">
    </p>
    <p>
        <strong>2. é€‰æ‹© Agent Key:</strong><br>
        <input type="text" id="agentKey" value="agent-01">
    </p>
    <button onclick="startTest()">â‘  æ¢å– Token å¹¶åˆå§‹åŒ–èŠå¤©æŒ‰é’®</button>
</div>

<div id="statusBox" class="status"></div>

<!-- èŠå¤©æŒ‰é’®ç›¸å…³ HTML -->
<div id="loading">æ­£åœ¨è¿æ¥å®‰å…¨é€šé“...</div>

<iframe id="float-btn"
    style="position:fixed;bottom:20px;right:20px;width:100px;height:100px;border:none;background:transparent;z-index:9999;display:none"
    frameborder="0" allow="microphone;camera">
</iframe>

<script>
    // æ ¸å¿ƒ Token å˜é‡
    let CURRENT_TOKEN = '';
    
    // è‡ªåŠ¨è¯†åˆ«å½“å‰ç½‘å…³çš„åœ°å€
    const GATEWAY_ORIGIN = window.location.origin;

    async function startTest() {
        const secret = document.getElementById('clientSecret').value;
        const key = document.getElementById('agentKey').value;
        const statusBox = document.getElementById('statusBox');
        
        statusBox.className = 'status';
        statusBox.innerText = 'æ­£åœ¨å‘ç½‘å…³è¯·æ±‚ Token...';

        try {
            // æ­¥éª¤ 1: è¯·æ±‚ç½‘å…³è·å– Token
            const response = await fetch(`/api/get-token?secret=${secret}`);
            const data = await response.json();

            if (data.success) {
                statusBox.className = 'status success';
                statusBox.innerText = `âœ… Token è·å–æˆåŠŸï¼æœ‰æ•ˆæœŸ 8 å°æ—¶ã€‚`;
                
                // æ­¥éª¤ 2: ä¿å­˜ Token å¹¶åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
                CURRENT_TOKEN = data.token;
                initChat();
            } else {
                throw new Error(data.error || 'è·å– Token å¤±è´¥');
            }
        } catch (err) {
            statusBox.className = 'status error';
            statusBox.innerText = `âŒ é”™è¯¯: ${err.message}`;
        }
    }

    async function initChat() {
        // æ£€æŸ¥ Token æ˜¯å¦è·å–æˆåŠŸ
        if (!CURRENT_TOKEN) {
            console.error('é”™è¯¯ï¼šToken æœªè·å–ï¼Œè¯·ç‚¹å‡»æŒ‰é’®æ¢å– Token');
            document.getElementById('loading').innerText = 'é…ç½®é”™è¯¯ï¼šè¯·å…ˆæ¢å– Token';
            return;
        }

        console.log('âœ… å®‰å…¨é€šé“å·²å»ºç«‹');
        document.getElementById('loading').style.display = 'none'; // éšè—åŠ è½½æç¤º

        // åŠ è½½æ‚¬æµ®çƒ
        const btnIframe = document.getElementById('float-btn');
        btnIframe.src = `${GATEWAY_ORIGIN}/next-chats/widget?key=agent-chat-button&token=${CURRENT_TOKEN}`;
        btnIframe.style.display = 'block'; // æ˜¾ç¤ºæŒ‰é’®
    }

    // ç›‘å¬æ¶ˆæ¯ (å¼¹å‡ºå¤§çª—å£)
    window.addEventListener('message', e => {
        if (e.origin !== GATEWAY_ORIGIN) return;
        if (e.data.type === 'UI_CONFIG') {
            // æ¥æ”¶æ¥è‡ªç½‘å…³é…ç½®çš„å®½é«˜ï¼Œå®ç°è‡ªåŠ¨ç¼©æ”¾
            const w = document.getElementById('chat-win');
            if (w) {
                w.style.width = e.data.width;
                w.style.height = e.data.height;
                console.log(`âœ… OA ç³»ç»Ÿå·²æ ¹æ®åç«¯é…ç½®è°ƒæ•´çª—å£: ${e.data.width}x${e.data.height}`);
            }
        }
        if (e.data.type === 'CREATE_CHAT_WINDOW') {
            if (document.getElementById('chat-win')) return;
            
    
            const safeSrc = `${GATEWAY_ORIGIN}/next-chats/widget?key=agent-01&token=${CURRENT_TOKEN}`;
    
            const i = document.createElement('iframe');
            i.id = 'chat-win';
            i.src = safeSrc;
            // æ ·å¼é…ç½®ï¼šå³ä¸‹è§’å¼¹å‡ºï¼Œå¸¦é˜´å½±
            i.style.cssText = `position:fixed;bottom:104px;right:24px;width:0;height:0;border:none;background:transparent;z-index:9998;display:none; box-shadow: 0 5px 20px rgba(0,0,0,0.2); border-radius: 8px; background-color: white;`;
            
            i.frameBorder = '0';
            i.allow = 'microphone;camera';
            document.body.appendChild(i);
            
        } else if (e.data.type === 'TOGGLE_CHAT') {
            const w = document.getElementById('chat-win');
            if (w) w.style.display = e.data.isOpen ? 'block' : 'none';
        }
    });
</script>

</body>
</html>