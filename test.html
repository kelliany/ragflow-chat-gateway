<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç½‘å…³é‰´æƒé›†æˆæµ‹è¯• - æ¨¡æ‹Ÿ OA ç³»ç»Ÿ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
        .config-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        .success { background: #e7f4e9; color: #2e7d32; display: block; }
        .error { background: #fbe9e7; color: #d84315; display: block; }
        iframe { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px; margin-top: 20px; background: white; }
        input { padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>

<div class="config-panel">
    <h2>ğŸ›¡ï¸ ç½‘å…³é‰´æƒæµ‹è¯•å·¥å…·</h2>
    <p>
        <strong>1. å¡«å†™å£ä»¤ (CLIENT_SECRET):</strong><br>
        <input type="password" id="clientSecret" value="bestvwin2026">
    </p>
    <p>
        <strong>2. é€‰æ‹© Agent Key:</strong><br>
        <input type="text" id="agentKey" value="agent-01">
    </p>
    <button onclick="startTest()">â‘  æ¢å– Token å¹¶åŠ è½½ Iframe</button>
</div>

<div id="statusBox" class="status"></div>

<div id="iframeContainer">
    </div>

<script>
    async function startTest() {
        const secret = document.getElementById('clientSecret').value;
        const key = document.getElementById('agentKey').value;
        const statusBox = document.getElementById('statusBox');
        const container = document.getElementById('iframeContainer');
        
        statusBox.className = 'status';
        statusBox.innerText = 'æ­£åœ¨å‘ç½‘å…³è¯·æ±‚ Token...';
        container.innerHTML = '';

        try {
            // æ­¥éª¤ 1: è¯·æ±‚ç½‘å…³è·å– Token
            // æ³¨æ„ï¼šå®é™… OA ç³»ç»Ÿä¸­ï¼Œè¿™ä¸€æ­¥åº”è¯¥åœ¨ OA çš„ã€åç«¯ã€‘æ‰§è¡Œï¼Œé˜²æ­¢ Secret æ³„éœ²ç»™å‰ç«¯ç”¨æˆ·
            const response = await fetch(`/api/get-token?secret=${secret}`);
            const data = await response.json();

            if (data.success) {
                statusBox.className = 'status success';
                statusBox.innerText = `âœ… Token è·å–æˆåŠŸï¼æœ‰æ•ˆæœŸ 8 å°æ—¶ã€‚`;
                
                // æ­¥éª¤ 2: æ‹¼æ¥å¸¦æœ‰ Token çš„ iframe åœ°å€
                // è¿™é‡Œçš„åœ°å€å¿…é¡»ç»è¿‡ä½ çš„ç½‘å…³ç«¯å£ (3030)
                const gatewayUrl = `${window.location.origin}/agent/share?key=${key}&token=${data.token}`;
                
                console.log('ç”Ÿæˆçš„ Iframe åœ°å€:', gatewayUrl);

                // æ­¥éª¤ 3: æ¸²æŸ“ Iframe
                const ifrm = document.createElement('iframe');
                ifrm.setAttribute('src', gatewayUrl);
                container.appendChild(ifrm);
            } else {
                throw new Error(data.error || 'è·å– Token å¤±è´¥');
            }
        } catch (err) {
            statusBox.className = 'status error';
            statusBox.innerText = `âŒ é”™è¯¯: ${err.message}`;
        }
    }
</script>

</body>
</html>